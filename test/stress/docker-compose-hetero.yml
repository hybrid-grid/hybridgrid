services:
  coordinator:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: hg-coord serve --grpc-port=9000 --http-port=8080
    ports:
      - "9000:9000"
      - "8080:8080"
    networks:
      - hgnet
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # Lightest worker
  worker-1:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: hg-worker serve --coordinator=coordinator:9000 --port=50051 --advertise-address=worker-1:50051 --max-parallel=1
    networks:
      - hgnet
    depends_on:
      - coordinator
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Light worker
  worker-2:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: hg-worker serve --coordinator=coordinator:9000 --port=50051 --advertise-address=worker-2:50051 --max-parallel=2
    networks:
      - hgnet
    depends_on:
      - coordinator
    deploy:
      resources:
        limits:
          cpus: '0.6'
          memory: 614M

  # Medium worker
  worker-3:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: hg-worker serve --coordinator=coordinator:9000 --port=50051 --advertise-address=worker-3:50051 --max-parallel=2
    networks:
      - hgnet
    depends_on:
      - coordinator
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 820M

  # Medium-heavy worker
  worker-4:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: hg-worker serve --coordinator=coordinator:9000 --port=50051 --advertise-address=worker-4:50051 --max-parallel=2
    networks:
      - hgnet
    depends_on:
      - coordinator
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M

  # Heavy worker
  worker-5:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: hg-worker serve --coordinator=coordinator:9000 --port=50051 --advertise-address=worker-5:50051 --max-parallel=3
    networks:
      - hgnet
    depends_on:
      - coordinator
    deploy:
      resources:
        limits:
          cpus: '1.1'
          memory: 1126M

  builder:
    build:
      context: ../..
      dockerfile: test/stress/Dockerfile.base
    command: sleep infinity
    environment:
      - HG_COORDINATOR=coordinator:9000
    networks:
      - hgnet
    depends_on:
      - coordinator
    volumes:
      - build-cache:/root/.hybridgrid/cache
      - cpython-src:/workspace
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    stdin_open: true
    tty: true

networks:
  hgnet:
    driver: bridge

volumes:
  build-cache:
  cpython-src:
